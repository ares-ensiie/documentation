<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1' name='viewport'>
    <link href="/assets/stylesheets/documentation.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/assets/javascripts/documentation.js" type="text/javascript"></script>
    <link rel="icon" type="image/png" href="https://s3-eu-west-1.amazonaws.com/ares-favicon/favicon.png">
  </head>
  <body class='developers developers_api developers_api_v1 developers_api_v1_setup developers_api_v1_setup_index'>
    <header class='notice'>
      <p>En cas de problème avec la documentation, veuillez <a href="https://github.com/ares-ensiie/documentation/issues/new">ouvrir une issue</a> ou nous contacter sur <a href="irc://irc.iiens.net/%23ares">#ares</a> ou <a href="mailto:ares@ares-ensiie.eu">ares@ares-ensiie.eu</a>. Suivez-nous sur <a href="https://github.com/ares-ensiie">github</a>!</p>
    </header>
    <article>
      <h1>Intégrer Oauth à son application web</h1>&#x000A;&#x000A;<h2>Enregistrer son application</h2>&#x000A;&#x000A;<p>Il faut aller sur <a href="http://developers.iiens.eu/oauth/applications/new">http://developers.iiens.eu/oauth/applications/new</a> et remplir les deux champs <code>Nom</code> et <code>redirect_uri</code>.&#x000A;Ces informations dépendent de l&#39;environnement (développement/production) et sont expliquées en détail dans la suite.&#x000A;Une fois le formulaire rempli, on récupère deux codes:</p>&#x000A;&#x000A;<ul>&#x000A;<li>CLIENT_ID</li>&#x000A;<li>CLIENT_SECRET</li>&#x000A;</ul>&#x000A;&#x000A;<p>Ces codes peuvent être vus comme des clés ssh publiques et privées.&#x000A;En aucun cas CLIENT_SECRET ne doit être divulgué, ce qui implique de ne pas l&#39;inclure dans le code source si celui-ci est disponible à tous.</p>&#x000A;&#x000A;<p>On les enregistre plutôt dans <code>.bashrc</code> ou <code>.zshrc</code> en tant que variables d&#39;environnement, sous cette forme:</p>&#x000A;<div class="highlight"><pre><span class="cp">#Ares</span>&#x000A;<span class="n">export</span> <span class="n">CLIENT_ID</span><span class="o">=</span><span class="s">&quot;blablabla&quot;</span>&#x000A;<span class="n">export</span> <span class="n">CLIENT_SECRET</span><span class="o">=</span><span class="s">&quot;blablablablabla&quot;</span>&#x000A;</pre></div>&#x000A;<p>On peut vérifier qu&#39;on y a accès depuis le shell comme cela (peut nécessiter un redémarrage du shell):</p>&#x000A;<div class="highlight"><pre><span class="n">echo</span> <span class="err">$</span><span class="n">CLIENT_ID</span>&#x000A;<span class="n">echo</span> <span class="err">$</span><span class="n">CLIENT_SECRET</span>&#x000A;</pre></div>&#x000A;<h3>Environnement de développement</h3>&#x000A;&#x000A;<ul>&#x000A;<li>Nom: mettre son prénom/nom</li>&#x000A;<li>redirect_uri: mettre l&#39;url de développement suffixée par <code>/auth</code>, par exemple <code>http://localhost:3000/auth</code></li>&#x000A;</ul>&#x000A;&#x000A;<h3>Environnement de production</h3>&#x000A;&#x000A;<ul>&#x000A;<li>Nom: mettre le nom de l&#39;application, par exemple Oauth-demo</li>&#x000A;<li>redirect_uri: mettre l&#39;url finale suffixée par <code>/auth</code>, par exemple <code>http://dashboard.ares-paas.eu/auth</code></li>&#x000A;</ul>&#x000A;&#x000A;<h2>Mettre en place l&#39;authentification</h2>&#x000A;&#x000A;<p>Cette partie n&#39;est pas exhaustive, elle ne montre que quelques exemples.</p>&#x000A;&#x000A;<hr>&#x000A;&#x000A;<p><strong>tl;dr:</strong></p>&#x000A;&#x000A;<ul>&#x000A;<li>Login: <code>/oauth</code></li>&#x000A;<li>Route <code>/auth</code> pour répondre à l&#39;api</li>&#x000A;<li><p>Informations importantes:</p>&#x000A;<div class="highlight"><pre><span class="p">{</span>&#x000A;<span class="nl">authorizationURL:</span> <span class="s">&quot;http://www.iiens.eu/oauth/authorize&quot;</span><span class="p">,</span>&#x000A;<span class="nl">tokenURL:</span> <span class="s">&quot;http://www.iiens.eu/oauth/token&quot;</span><span class="p">,</span>&#x000A;<span class="nl">clientID:</span> <span class="n">process</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">CLIENT_ID</span><span class="p">,</span>&#x000A;<span class="nl">clientSecret:</span> <span class="n">process</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>&#x000A;<span class="nl">callbackURL:</span> <span class="s">&quot;/auth&quot;</span><span class="p">,</span>&#x000A;<span class="p">}</span>&#x000A;</pre></div></li>&#x000A;</ul>&#x000A;&#x000A;<hr>&#x000A;&#x000A;<h3>Manuellement</h3>&#x000A;&#x000A;<p>Exemples complets présents <a href="https://github.com/gaultier/oauth-demo">ici</a> (avec <code>ares_api</code>)&#x000A; et <a href="https://github.com/ares-ensiie/oauth-demo">là</a> (sans <code>ares_api</code>).</p>&#x000A;&#x000A;<p>Lorsque l&#39;utilisateur se connecte, on enregistre ses informations dans une variable de session,&#x000A;et pour chaque page, on vérifie l&#39;existence et la validité de cette variable, pour savoir si l&#39;utilisateur est connecté ou pas.</p>&#x000A;&#x000A;<p>On peut mettre en place ce systême complètement manuellement&#x000A;ou bien utiliser le module <code>ares_api</code> (pour Nodejs): <a href="https://github.com/gaultier/ares_api">ares_api</a></p>&#x000A;&#x000A;<h3>Passeport (Nodejs)</h3>&#x000A;&#x000A;<p>Exemple complet présent <a href="https://github.com/MaximeHeckel/HarborJS">ici</a>.</p>&#x000A;&#x000A;<p>Cet exemple utilise une classe <code>User</code> qui se trouve dans <code>app/models/user</code>, qui peut se résumer à:</p>&#x000A;<div class="highlight"><pre><span class="p">{</span>&#x000A;    <span class="nl">local:</span>&#x000A;    <span class="p">{</span>&#x000A;        <span class="nl">username:</span> <span class="n">String</span><span class="p">,</span>&#x000A;        <span class="nl">password:</span> <span class="n">String</span><span class="p">,</span>&#x000A;    <span class="p">}</span>&#x000A;<span class="p">}</span>&#x000A;</pre></div>&#x000A;<p>Dans <code>routes.js</code>, il faut créer les routes suivantes:</p>&#x000A;<div class="highlight"><pre> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>&#x000A;    <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>&#x000A;    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>&#x000A;  <span class="p">});</span>&#x000A;&#x000A;  <span class="c1">//Oauth</span>&#x000A;  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/oauth&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;oauth2&#39;</span><span class="p">));</span>&#x000A;&#x000A;  <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">,</span>&#x000A;    <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;oauth2&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">failureRedirect</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span> <span class="p">}),</span>&#x000A;    <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="c1">// Successful authentication, redirect home.</span>&#x000A;      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/profile&#39;</span><span class="p">);</span>&#x000A;    <span class="p">});</span>&#x000A;</pre></div>&#x000A;<p>Dans <code>config/passeport.js</code>, il faut créer plusieurs fonctions:</p>&#x000A;&#x000A;<ul>&#x000A;<li><code>serializeUser</code>: enregistre l&#39;id de l&#39;utilisateur dans la base de données</li>&#x000A;<li><code>deserializeUser</code>: trouve l&#39;utilisateur dans la base de données à partir de son id</li>&#x000A;<li><code>userProfile</code>: acquiert les informations de l&#39;utilisateur grâce à un appel à l&#39;api</li>&#x000A;<li><code>use</code>: met en place l&#39;authentification en tant que telle.</li>&#x000A;</ul>&#x000A;&#x000A;<p>Cette dernière exécute une requête à l&#39;api, si l&#39;authentification est réussie,&#x000A;elle récupère un token valide et les informations de l&#39;utilisateur qui vient de se logger (grâce à la fonction <code>userProfile</code>).&#x000A;Ensuite, si l&#39;utilisateur n&#39;existe pas dans la base de données (première connexion), elle l&#39;y enregistre, sinon elle quitte.</p>&#x000A;<div class="highlight"><pre>    <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">OAuth2Strategy</span><span class="p">({</span>&#x000A;      <span class="nx">authorizationURL</span><span class="o">:</span> <span class="s2">&quot;http://www.iiens.eu/oauth/authorize&quot;</span><span class="p">,</span>&#x000A;      <span class="nx">tokenURL</span><span class="o">:</span> <span class="s2">&quot;http://www.iiens.eu/oauth/token&quot;</span><span class="p">,</span>&#x000A;      <span class="nx">clientID</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLIENT_ID</span><span class="p">,</span>&#x000A;      <span class="nx">clientSecret</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CLIENT_SECRET</span><span class="p">,</span>&#x000A;      <span class="nx">callbackURL</span><span class="o">:</span> <span class="s2">&quot;/auth&quot;</span><span class="p">,</span>&#x000A;    <span class="p">}</span> <span class="p">,</span>&#x000A;    <span class="kd">function</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">refreshToken</span><span class="p">,</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>&#x000A;      <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="s2">&quot;local.username&quot;</span><span class="o">:</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">username</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>&#x000A;        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span> <span class="o">||</span> <span class="nx">err</span><span class="p">){</span>&#x000A;          <span class="kd">var</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>&#x000A;          <span class="nx">newUser</span><span class="p">.</span><span class="nx">local</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>&#x000A;          <span class="nx">newUser</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>&#x000A;            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>&#x000A;            <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">newUser</span><span class="p">);</span>&#x000A;          <span class="p">})</span>&#x000A;        <span class="p">}</span>&#x000A;        <span class="k">else</span> <span class="p">{</span>&#x000A;          <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>&#x000A;        <span class="p">}</span>&#x000A;      <span class="p">});</span>&#x000A;    <span class="p">}));</span>&#x000A;&#x000A;<span class="p">};</span>&#x000A;</pre></div>
    </article>
  </body>
</html>
